name: Generar Contexto del Repositorio

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'contexto_repo.txt' # Evitar que el workflow se active cuando solo este archivo cambie

jobs:
  generate-context:
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Clonar el repositorio
        uses: actions/checkout@v3

      - name: 游띔 Verificar si el commit fue hecho por GitHub Actions
        run: |
          if git log -1 --pretty=format:'%an' | grep -q 'github-actions'; then
            echo "Este commit fue generado por GitHub Actions, deteniendo ejecuci칩n..."
            exit 0
          fi

      - name: 游닇 Generar lista de archivos y contenido
        run: |
          echo "### Estructura de archivos y carpetas ###" > contexto_repo.txt
          tree -a -I '.git|node_modules' >> contexto_repo.txt

          echo "\n### Contenido de archivos clave ###" >> contexto_repo.txt
          find . -type f \( -name "*.ts" -o -name "*.json" -o -name "*.yml" -o -name "*.md" \) ! -path "*/node_modules/*" -exec echo -e "\n----- {} -----\n" \; -exec cat {} \; >> contexto_repo.txt

      - name: 游댃 Commit y Push de la actualizaci칩n
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add contexto_repo.txt
          git commit -m "游댃 Actualizaci칩n autom치tica del contexto del repo" || exit 0  # Evita error si no hay cambios
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Cambiar por MY_PAT_TOKEN si es necesario
